<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能云收账系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #10b981; --bg: #f1f5f9; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; }
        .glass-nav { background: rgba(16, 185, 129, 0.95); backdrop-filter: blur(10px); }
        input, select { outline: none !important; }
        .record-card { transition: all 0.2s; }
        .record-card:active { transform: scale(0.98); }
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-20">

    <div id="loading-screen">
        <div class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div class="text-slate-400 text-sm">正在连接云端服务...</div>
    </div>

    <!-- 登录遮罩层 -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-100 z-[2000] flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl p-8 text-center">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-6">云端系统验证</h2>
            <input type="text" id="user-id" placeholder="用户 ID" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center font-bold">
            <input type="password" id="pass-input" placeholder="登录密码" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl mb-6 text-center font-bold">
            <p id="login-msg" class="text-red-500 text-sm mb-4 hidden"></p>
            <button id="btn-login" class="w-full py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-200 active:scale-95 transition-transform">立即登录</button>
        </div>
    </div>

    <!-- 主界面 -->
    <nav class="glass-nav text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-2">
            <div class="bg-white/20 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            </div>
            <span class="font-bold tracking-wide" id="nav-title">智能云收账</span>
        </div>
        <button id="btn-logout" class="p-2 bg-black/10 rounded-lg active:scale-90 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
        </button>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-4 hidden" id="main-app">
        <!-- 统计 -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">今日累计</p>
                <p class="text-xl font-black text-emerald-600" id="today-total">RM 0.00</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">操作员</p>
                <p class="text-xl font-black text-blue-600 truncate" id="current-op">-</p>
            </div>
        </div>

        <!-- 记账表单 -->
        <div class="bg-white p-5 rounded-3xl shadow-sm space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-1">电讯商</label>
                    <select id="telco" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm font-semibold"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-1">金额 RM</label>
                    <input type="number" id="amount" placeholder="0.00" step="0.01" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm font-semibold">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-1">支付方式</label>
                    <select id="payment" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm font-semibold"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-1">客户群体</label>
                    <select id="group" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm font-semibold"></select>
                </div>
            </div>

            <button id="btn-add" class="w-full py-4 bg-emerald-500 text-white font-bold rounded-2xl shadow-lg shadow-emerald-100 active:scale-95 transition-transform flex items-center justify-center gap-2 mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                确认并存入云端
            </button>
        </div>

        <div id="record-list" class="space-y-3"></div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm shadow-2xl opacity-0 transition-opacity z-[3000] pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ========================================================
        // 1. 核心配置：请务必替换为你自己的 Firebase 配置
        // ========================================================
        const firebaseConfig = {
		  apiKey: "AIzaSyDRKsIjOw398wYpvhHlLNrqEGlV-pq3AdY",
		  authDomain: "myphoneshop-cf5ae.firebaseapp.com",
		  projectId: "myphoneshop-cf5ae",
		  storageBucket: "myphoneshop-cf5ae.firebasestorage.app",
		  messagingSenderId: "117311435705",
		  appId: "1:117311435705:web:e53f5f9813798c57e33c68",
		  measurementId: "G-62KPF9GFKK"
		};

        // ========================================================
        // 2. 备选配置：如果你还没有 config.json 和 user.json，系统会使用以下默认值
        // ========================================================
        const DEFAULT_SYSTEM_CONFIG = {
            telcoOptions: ["Maxis", "Digi", "Celcom", "U Mobile", "RedONE", "Yes", "XOX", "Unifi"],
            paymentMethods: ["Cash", "TNG", "Bank Transfer"],
            customerGroups: ["普通客户", "熟客", "批发商"]
        };

        const DEFAULT_USER_CONFIG = {
            users: [
                { id: "admin", password: "123" },
                { id: "staff", password: "456" }
            ]
        };

        const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig;
        
        let db, auth;
        try {
            const app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'phone-billing-v2';
        let SYSTEM_CONFIG = DEFAULT_SYSTEM_CONFIG;
        let USER_CONFIG = DEFAULT_USER_CONFIG;
        let records = [];

        async function init() {
            // 尝试加载本地文件，如果加载失败则使用默认值
            try {
                const cRes = await fetch('config.json');
                const uRes = await fetch('user.json');
                if (cRes.ok) SYSTEM_CONFIG = await cRes.json();
                if (uRes.ok) USER_CONFIG = await uRes.json();
            } catch (e) {
                console.log("使用内置默认配置运行");
            }
            
            populateSelects();
            checkAuth();
            document.getElementById('loading-screen')?.remove();
        }

        function populateSelects() {
            const fill = (id, list) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = list.map(i => `<option value="${i}">${i}</option>`).join('');
            };
            fill('telco', SYSTEM_CONFIG.telcoOptions);
            fill('payment', SYSTEM_CONFIG.paymentMethods);
            fill('group', SYSTEM_CONFIG.customerGroups);
        }

        document.getElementById('btn-login').addEventListener('click', () => {
            const id = document.getElementById('user-id').value;
            const pw = document.getElementById('pass-input').value;
            const msg = document.getElementById('login-msg');

            const valid = USER_CONFIG.users?.find(u => u.id === id && u.password === pw);
            if (valid) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('userName', id);
                enterApp();
            } else {
                msg.innerText = "ID 或密码错误";
                msg.classList.remove('hidden');
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            sessionStorage.clear();
            location.reload();
        });

        document.getElementById('btn-add').addEventListener('click', async () => {
            const amtVal = document.getElementById('amount').value;
            const amt = parseFloat(amtVal);
            if (!amt || isNaN(amt)) return showToast("请输入有效金额");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'records'), {
                    telco: document.getElementById('telco').value,
                    amount: amt,
                    payment: document.getElementById('payment').value,
                    group: document.getElementById('group').value,
                    createdBy: sessionStorage.getItem('userName'),
                    timestamp: serverTimestamp()
                });
                document.getElementById('amount').value = '';
                showToast("✅ 云端已同步");
            } catch (e) {
                showToast("❌ 保存失败，请检查数据库权限");
                console.error(e);
            }
        });

        window.deleteRec = async (id) => {
            if (confirm("确定要删除这条云端记录吗？")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', id));
                    showToast("已删除");
                } catch (e) {
                    showToast("删除失败");
                }
            }
        };

        async function enterApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('current-op').innerText = sessionStorage.getItem('userName');
            
            try {
                await signInAnonymously(auth);
                startListening();
            } catch (e) {
                showToast("连接 Firebase 失败");
            }
        }

        function startListening() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'records'));
            onSnapshot(q, (snapshot) => {
                records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderRecords();
            }, (error) => {
                console.error("Firestore Listen Error:", error);
                if (error.code === 'permission-denied') {
                    showToast("权限不足：请在 Firebase 控制台设置 Rules");
                }
            });
        }

        function renderRecords() {
            const list = document.getElementById('record-list');
            const totalEl = document.getElementById('today-total');
            let total = 0;

            list.innerHTML = records.map(r => {
                total += r.amount || 0;
                const time = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                return `
                    <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-slate-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl ${r.payment === 'Cash' ? 'bg-emerald-50 text-emerald-600' : 'bg-blue-50 text-blue-600'} flex items-center justify-center font-bold text-xs">
                                ${r.payment === 'Cash' ? '现金' : '电子'}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">${r.telco}</h4>
                                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${time} · ${r.createdBy}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-emerald-600">RM ${r.amount?.toFixed(2)}</span>
                            <button onclick="deleteRec('${r.id}')" class="text-slate-200 hover:text-red-400 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            totalEl.innerText = `RM ${total.toFixed(2)}`;
        }

        function checkAuth() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                enterApp();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        init();
    </script>
</body>
</html>