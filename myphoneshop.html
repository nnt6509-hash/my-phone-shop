<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯æ”¶è´¦ç³»ç»Ÿ</title>
    <!-- Firebase SDK (å…¼å®¹ç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #10b981; --primary-dark: #059669; --bg: #f1f5f9; --error: #ef4444; --warning: #f59e0b; --dark: #1e293b; --blue: #3b82f6; --purple: #8b5cf6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--dark); overflow-x: hidden; }
        
        /* ç™»å½•é®ç½© */
        #login-overlay { position: fixed; inset: 0; background: var(--dark); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: white; width: 100%; max-width: 350px; border-radius: 30px; padding: 30px; text-align: center; }

        /* å¯¼èˆªæ  */
        nav { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo h1 { margin: 0; font-size: 18px; font-weight: 900; }
        .user-info { font-size: 10px; opacity: 0.9; }

        main { max-width: 450px; margin: 0 auto; padding: 15px; }

        /* æ±‡æ€»å¡ç‰‡ */
        .summary-card { background: linear-gradient(135deg, var(--dark), #334155); border-radius: 24px; padding: 20px; color: white; margin-bottom: 15px; position: relative; }
        .summary-value { font-size: 28px; font-weight: 900; color: var(--primary); margin: 5px 0; }
        
        /* æ ¸å¿ƒå¡ç‰‡ */
        .card { background: white; border-radius: 24px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 11px; font-weight: 800; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; }
        select, input { width: 100%; padding: 14px; border-radius: 14px; border: 2px solid #f1f5f9; background: #f8fafc; font-size: 16px; font-weight: bold; outline: none; }
        select:focus, input:focus { border-color: var(--primary); background: white; }
        
        .btn-submit { width: 100%; padding: 18px; border: none; background: var(--primary); color: white; border-radius: 18px; font-size: 16px; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .btn-submit:active { transform: scale(0.98); }

        /* é€‰é¡¹å¡ */
        .tabs { display: flex; background: #e2e8f0; padding: 5px; border-radius: 15px; margin-bottom: 15px; gap: 5px; }
        .tab-btn { flex: 1; border: none; padding: 12px 5px; border-radius: 12px; font-weight: bold; cursor: pointer; background: transparent; color: #64748b; font-size: 13px; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* åˆ—è¡¨é¡¹ */
        .record-item { background: white; border-radius: 18px; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .record-info h4 { margin: 0; font-size: 15px; }
        .record-info p { margin: 4px 0 0; font-size: 11px; color: #94a3b8; }
        .record-amount { text-align: right; font-weight: 900; color: var(--primary); }

        /* ä¾§è¾¹åº“å­˜ */
        .side-panel { position: fixed; right: -280px; top: 0; width: 260px; height: 100%; background: white; z-index: 1001; transition: 0.4s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1); overflow-y: auto; }
        .side-panel.open { right: 0; }
        .side-btn { position: fixed; right: 0; top: 40%; background: var(--dark); color: white; padding: 10px 5px; border-radius: 10px 0 0 10px; writing-mode: vertical-lr; cursor: pointer; font-size: 12px; z-index: 99; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- ç™»å½• -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>èŒå‘˜ç™»å½•</h2>
            <div class="form-group">
                <select id="login-select"></select>
            </div>
            <button class="btn-submit" onclick="login()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
    </div>

    <nav>
        <div class="logo">
            <h1 id="shop-name-title">åŠ è½½ä¸­...</h1>
            <div class="user-info">èŒå‘˜: <span id="current-user-display">æœªç™»å½•</span></div>
        </div>
        <div id="sync-status" style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px;">åŒæ­¥ä¸­...</div>
    </nav>

    <div class="side-btn" onclick="toggleSide()">å®æ—¶åº“å­˜ â¯</div>
    <div id="side-panel" class="side-panel">
        <h3>åº“å­˜ä½™é¢</h3>
        <div id="side-inventory-list"></div>
        <button class="btn-submit" style="margin-top:20px; background:#e2e8f0; color:black;" onclick="toggleSide()">å…³é—­</button>
    </div>

    <main>
        <div class="summary-card">
            <div style="font-size:11px; opacity:0.8;">ä»Šæ—¥è¿›è´¦ (å·²æ”¶)</div>
            <div class="summary-value">RM <span id="today-total">0.00</span></div>
            <div id="debt-alert" style="color:#fca5a5; font-size:10px; font-weight:bold; display:none;">âš ï¸ å­˜åœ¨æœªæ”¶æ¸…çš„æ¬ æ¬¾</div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="tab-form" onclick="showTab('form')">è®°è´¦</button>
            <button class="tab-btn" id="tab-list" onclick="showTab('list')">è®°å½•</button>
            <button class="tab-btn" id="tab-debt" onclick="showTab('debt')">æ¬ æ¬¾</button>
        </div>

        <div id="section-form">
            <div class="card">
                <form id="main-form">
                    <div class="form-group">
                        <label class="form-label">æ“ä½œç±»å‹</label>
                        <select id="type-select" onchange="toggleFormMode()">
                            <option value="sale">é”€å”®è®°å½•</option>
                            <option value="plus">è¡¥åº“å­˜ (å¢åŠ ä½™é¢)</option>
                            <option value="debt">ğŸ›‘ èµŠè´¦ (å®¢æˆ·æœªä»˜)</option>
                        </select>
                    </div>
                    <div id="normal-fields">
                        <div class="form-group">
                            <label class="form-label">ç”µè®¯å•†</label>
                            <select id="field-telco"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ‰‹æœºå·/å¤‡æ³¨</label>
                            <input type="text" id="field-phone" placeholder="01x-xxxxxxx">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é‡‘é¢ RM</label>
                            <input type="number" step="0.01" id="field-amount" required>
                        </div>
                        <div class="form-group" id="paymethod-group">
                            <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
                            <select id="field-method"></select>
                        </div>
                        <div class="form-group hidden" id="debt-name-group">
                            <label class="form-label">æ¬ æ¬¾äººå§“å</label>
                            <input type="text" id="field-debt-name" placeholder="è¯·è¾“å…¥å§“å">
                        </div>
                    </div>
                    <button type="submit" class="btn-submit">ç¡®è®¤å¹¶åŒæ­¥åˆ°äº‘ç«¯</button>
                </form>
            </div>
        </div>

        <div id="section-list" class="hidden">
            <div id="record-container"></div>
        </div>

        <div id="section-debt" class="hidden">
            <div id="debt-container"></div>
        </div>
    </main>

    <script>
        // ---------------------------------------------------------
        // 1. é…ç½® Firebase (è¯·å¡«å…¥ä½ è‡ªå·±çš„é…ç½®)
        // ---------------------------------------------------------
        const firebaseConfig = {
			apiKey: "AIzaSyDRKsIjOw398wYpvhHlLNrqEGlV-pq3AdY",
			authDomain: "myphoneshop-cf5ae.firebaseapp.com",
			projectId: "myphoneshop-cf5ae",
			storageBucket: "myphoneshop-cf5ae.firebasestorage.app",
			messagingSenderId: "117311435705",
			appId: "1:117311435705:web:e53f5f9813798c57e33c68",
			measurementId: "G-62KPF9GFKK"
  };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = "";
        let configData = {};

        // ---------------------------------------------------------
        // 2. åˆå§‹åŒ–æµç¨‹
        // ---------------------------------------------------------
        async function init() {
            try {
                const [uRes, cRes] = await Promise.all([fetch('user.json'), fetch('config.json')]);
                const userJson = await uRes.json();
                configData = await cRes.json();

                // UIè®¾ç½®
                document.getElementById('shop-name-title').innerText = userJson.shopName;
                const lSel = document.getElementById('login-select');
                userJson.staff.forEach(s => lSel.add(new Option(s, s)));

                // å¡«å……è¡¨å•
                const tSel = document.getElementById('field-telco');
                configData.telcoOptions.forEach(t => tSel.add(new Option(t, t)));
                const mSel = document.getElementById('field-method');
                configData.paymentMethods.forEach(m => mSel.add(new Option(m, m)));

                await auth.signInAnonymously();
                document.getElementById('sync-status').innerText = "äº‘ç«¯åœ¨çº¿";
            } catch (e) {
                alert("åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·ç¡®ä¿ user.json å’Œ config.json åœ¨æ ¹ç›®å½•");
            }
        }

        function login() {
            currentUser = document.getElementById('login-select').value;
            document.getElementById('current-user-display').innerText = currentUser;
            document.getElementById('login-overlay').style.display = 'none';
            startRealtimeSync();
        }

        // ---------------------------------------------------------
        // 3. å®æ—¶äº‘ç«¯åŒæ­¥ (Firestore)
        // ---------------------------------------------------------
        function startRealtimeSync() {
            // è®°å½•ç›‘å¬
            db.collection("records").orderBy("time", "desc").limit(50).onSnapshot(snap => {
                const recs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderRecords(recs);
                updateSummary(recs);
            });

            // æ¬ æ¬¾ç›‘å¬
            db.collection("debts").onSnapshot(snap => {
                const debts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderDebts(debts);
            });

            // åº“å­˜ç›‘å¬
            db.collection("inventory").onSnapshot(snap => {
                const inv = {};
                snap.forEach(d => inv[d.id] = d.data().val);
                renderInventory(inv);
            });
        }

        // ---------------------------------------------------------
        // 4. æ“ä½œé€»è¾‘
        // ---------------------------------------------------------
        document.getElementById('main-form').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('type-select').value;
            const telco = document.getElementById('field-telco').value;
            const amount = parseFloat(document.getElementById('field-amount').value);
            const phone = document.getElementById('field-phone').value;
            const method = type === 'debt' ? 'Credit' : document.getElementById('field-method').value;
            const debtName = document.getElementById('field-debt-name').value;

            const batch = db.batch();
            
            // 1. å¢åŠ æµæ°´è®°å½•
            const recRef = db.collection("records").doc();
            batch.set(recRef, {
                type, telco, amount, phone, method, staff: currentUser,
                debtName: type === 'debt' ? debtName : "",
                time: Date.now(),
                dateStr: new Date().toDateString()
            });

            // 2. æ›´æ–°åº“å­˜ (è¿™é‡Œä½¿ç”¨ increment åŸå­æ“ä½œ)
            const invRef = db.collection("inventory").doc(telco);
            const change = (type === 'plus') ? amount : (type === 'sale' || type === 'debt' ? -amount : 0);
            batch.set(invRef, { val: firebase.firestore.FieldValue.increment(change) }, { merge: true });

            // 3. å¦‚æœæ˜¯èµŠè´¦ï¼ŒåŠ åˆ°æ¬ æ¬¾è¡¨
            if (type === 'debt') {
                const debtRef = db.collection("debts").doc();
                batch.set(debtRef, { name: debtName, amount, phone, time: Date.now() });
            }

            await batch.commit();
            e.target.reset();
            toggleFormMode();
            alert("åŒæ­¥æˆåŠŸï¼");
        };

        // è¿˜æ¬¾é€»è¾‘
        window.repayDebt = async (id, name, amount, phone) => {
            if (!confirm(`ç¡®è®¤æ”¶åˆ° ${name} çš„è¿˜æ¬¾ RM ${amount}ï¼Ÿ`)) return;
            
            const batch = db.batch();
            // åˆ é™¤æ¬ æ¬¾
            batch.delete(db.collection("debts").doc(id));
            // å¢åŠ ä¸€æ¡è¿˜æ¬¾æµæ°´
            batch.set(db.collection("records").doc(), {
                type: 'repay',
                telco: 'Repay',
                amount: amount,
                phone: phone,
                method: 'Cash/Online',
                staff: currentUser,
                debtName: name,
                time: Date.now(),
                dateStr: new Date().toDateString()
            });
            await batch.commit();
        };

        // ---------------------------------------------------------
        // 5. UI æ¸²æŸ“æ¸²æŸ“
        // ---------------------------------------------------------
        function renderRecords(recs) {
            const container = document.getElementById('record-container');
            container.innerHTML = recs.map(r => `
                <div class="record-item">
                    <div class="record-info">
                        <h4>${r.phone || 'æ— å·ç '}</h4>
                        <p>${r.telco} | ${r.staff} | ${r.method}</p>
                    </div>
                    <div class="record-amount" style="color:${r.type==='debt'?'red':(r.type==='plus'?'#3b82f6':'#10b981')}">
                        ${r.type==='plus'?'+':''}RM ${r.amount.toFixed(2)}
                    </div>
                </div>
            `).join('');
        }

        function renderDebts(debts) {
            const container = document.getElementById('debt-container');
            document.getElementById('debt-alert').style.display = debts.length > 0 ? 'block' : 'none';
            if (debts.length === 0) { container.innerHTML = '<p style="text-align:center;color:#94a3b8">æš‚æ— æ¬ æ¬¾è®°å½•</p>'; return; }
            container.innerHTML = debts.map(d => `
                <div class="record-item" style="border-left:5px solid red">
                    <div class="record-info">
                        <h4>${d.name}</h4>
                        <p>ç”µè¯: ${d.phone} | ${new Date(d.time).toLocaleDateString()}</p>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:900; color:red">RM ${d.amount.toFixed(2)}</div>
                        <button onclick="repayDebt('${d.id}','${d.name}',${d.amount},'${d.phone}')" style="margin-top:5px; font-size:10px; padding:4px 8px; background:var(--primary); color:white; border:none; border-radius:5px;">æ”¶é’±</button>
                    </div>
                </div>
            `).join('');
        }

        function renderInventory(inv) {
            const list = document.getElementById('side-inventory-list');
            list.innerHTML = configData.telcoOptions.map(t => {
                const val = inv[t] || 0;
                return `
                    <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f1f5f9">
                        <span style="font-weight:bold">${t}</span>
                        <span style="font-weight:900; color:${val < 50 ? 'red' : 'var(--primary)'}">RM ${val.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }

        function updateSummary(recs) {
            const today = new Date().toDateString();
            const total = recs.filter(r => r.dateStr === today && r.type !== 'debt' && r.type !== 'plus')
                              .reduce((sum, r) => sum + r.amount, 0);
            document.getElementById('today-total').innerText = total.toFixed(2);
        }

        // å·¥å…·å‡½æ•°
        window.toggleSide = () => document.getElementById('side-panel').classList.toggle('open');
        window.showTab = (t) => {
            ['form', 'list', 'debt'].forEach(s => {
                document.getElementById('section-' + s).classList.toggle('hidden', s !== t);
                document.getElementById('tab-' + s).classList.toggle('active', s === t);
            });
        };
        window.toggleFormMode = () => {
            const type = document.getElementById('type-select').value;
            document.getElementById('paymethod-group').classList.toggle('hidden', type === 'debt');
            document.getElementById('debt-name-group').classList.toggle('hidden', type !== 'debt');
        };

        init();
    </script>
</body>
</html>