<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手机店智能系统 - 自动配置版</title>
    <style>
        :root { --primary: #10b981; --primary-dark: #059669; --bg: #f1f5f9; --error: #ef4444; --warning: #f59e0b; --dark: #1e293b; --blue: #3b82f6; --purple: #8b5cf6; --tng: #0052cc; --cash: #059669; --bank: #ea580c; --debt: #dc2626; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--dark); overflow-x: hidden; }
        
        /* 登录界面样式 */
        #login-overlay { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .login-box h2 { margin-top: 0; color: var(--primary); text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* 主体布局 */
        #main-content { display: none; }
        nav { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { padding: 20px; max-width: 600px; margin: auto; padding-bottom: 100px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        
        /* 数据显示 */
        .record-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .type-minus { border-left-color: var(--error); }
        .type-plus { border-left-color: var(--primary); }
        .type-repay { border-left-color: var(--purple); }

        /* 侧边栏 */
        #side-panel { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 200; transition: 0.3s; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; }
        #side-panel.open { left: 0; }
        #side-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199; display: none; }
    </style>
</head>
<body>

    <!-- 登录层 -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>系统登录</h2>
            <div id="login-msg" style="color:red; text-align:center; font-size:12px; height:15px;"></div>
            <input type="text" id="login-user" placeholder="请输入账号">
            <input type="password" id="login-pass" placeholder="请输入密码">
            <button onclick="attemptLogin()">进入系统</button>
            <p style="font-size: 10px; color: #999; text-align: center; margin-top: 20px;">数据将自动从 user.json 与 config.json 加载</p>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="main-content">
        <nav>
            <div style="display:flex; align-items:center;">
                <span onclick="toggleSidePanel()" style="margin-right:15px; cursor:pointer; font-size:20px;">☰</span>
                <b id="nav-title">收账系统</b>
            </div>
            <span id="live-bal-view" style="font-size: 12px; background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 5px;">加载中...</span>
        </nav>

        <div class="container">
            <div class="card">
                <div class="form-group">
                    <label>交易类型</label>
                    <div class="btn-grid">
                        <button id="mode-sale" class="btn-main" onclick="setMode('minus')">卖出 (收账)</button>
                        <button id="mode-stock" style="background:#ddd;" onclick="setMode('plus')">补库存</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>电讯商</label>
                    <select id="telco" onchange="updateLivePreview()"></select>
                </div>

                <div id="sale-fields">
                    <div class="form-group">
                        <label>客户群组</label>
                        <select id="cust-group"></select>
                    </div>
                    <div class="form-group">
                        <label>客户姓名</label>
                        <input type="text" id="cust-name" placeholder="选填">
                    </div>
                    <div class="form-group">
                        <label>手机号/备忘</label>
                        <input type="tel" id="phone" placeholder="手机号或记录">
                    </div>
                </div>

                <div class="form-group">
                    <label id="amt-label">卖出金额 (RM)</label>
                    <input type="number" id="amount" step="0.01" placeholder="0.00">
                </div>

                <div class="form-group" id="pay-group">
                    <label>支付方式</label>
                    <select id="pay-method"></select>
                </div>

                <button class="btn-main" style="width:100%; margin-top:10px; padding:15px;" onclick="addRecord()">提交记录</button>
            </div>

            <h3 id="record-title">今日记录 (0)</h3>
            <div id="record-list"></div>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div id="side-overlay" onclick="toggleSidePanel()"></div>
    <div id="side-panel">
        <h3 style="color:var(--primary)">功能菜单</h3>
        <hr>
        <button onclick="exportCSV()" style="width:100%; margin:5px 0; background:#eee;">导出今日 CSV</button>
        <div style="margin-top:20px; font-size:12px; color:#666;">
            <p>提示：GitHub 环境无法自动同步数据。请定期使用导出功能备份到本地。</p>
        </div>
    </div>

    <script>
        let TELCOS = [];
        let GROUPS = [];
        let METHODS = [];
        let USERS = [];
        
        let currentMode = 'minus';
        let records = JSON.parse(localStorage.getItem('my_billing_v1') || '[]');
        let balances = JSON.parse(localStorage.getItem('my_balances_v1') || '{}');

        // 1. 加载配置文件
        async function loadConfigs() {
            try {
                const configRes = await fetch('config.json');
                const config = await configRes.json();
                TELCOS = config.telcoOptions;
                GROUPS = config.customerGroups;
                METHODS = config.paymentMethods;

                const userRes = await fetch('user.json');
                const userData = await userRes.json();
                USERS = userData.users;

                renderDropdowns();
                initBalances();
            } catch (e) {
                console.error("加载 JSON 失败:", e);
                alert("无法找到 config.json 或 user.json，请检查文件是否在同一目录。");
            }
        }

        function renderDropdowns() {
            const t = document.getElementById('telco');
            t.innerHTML = TELCOS.map(v => `<option value="${v}">${v}</option>`).join('');
            
            const g = document.getElementById('cust-group');
            g.innerHTML = GROUPS.map(v => `<option value="${v}">${v}</option>`).join('');
            
            const p = document.getElementById('pay-method');
            p.innerHTML = METHODS.map(v => `<option value="${v}">${v}</option>`).join('');
            updateLivePreview();
        }

        function initBalances() {
            TELCOS.forEach(t => { if(!balances[t]) balances[t] = 0; });
        }

        // 2. 登录逻辑
        function attemptLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const found = USERS.find(user => user.id === u && user.password === p);

            if (found) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                updateUI();
            } else {
                document.getElementById('login-msg').innerText = "账号或密码错误";
            }
        }

        // 3. 业务逻辑
        function setMode(m) {
            currentMode = m;
            document.getElementById('mode-sale').style.background = m === 'minus' ? 'var(--primary)' : '#ddd';
            document.getElementById('mode-stock').style.background = m === 'plus' ? 'var(--primary)' : '#ddd';
            document.getElementById('sale-fields').style.display = m === 'minus' ? 'block' : 'none';
            document.getElementById('pay-group').style.display = m === 'minus' ? 'block' : 'none';
            document.getElementById('amt-label').innerText = m === 'minus' ? '卖出金额 (RM)' : '补库存金额 (RM)';
        }

        function addRecord() {
            const amt = parseFloat(document.getElementById('amount').value);
            const telco = document.getElementById('telco').value;
            if(!amt) return alert("请输入金额");

            const rec = {
                id: Date.now(),
                type: currentMode,
                telco: telco,
                amount: amt,
                group: document.getElementById('cust-group').value,
                name: document.getElementById('cust-name').value || '无名',
                phone: document.getElementById('phone').value,
                method: document.getElementById('pay-method').value,
                time: new Date().toLocaleString()
            };

            if(currentMode === 'minus') balances[telco] -= amt;
            else balances[telco] += amt;

            records.unshift(rec);
            saveData();
            updateUI();
            document.getElementById('amount').value = '';
        }

        function saveData() {
            localStorage.setItem('my_billing_v1', JSON.stringify(records));
            localStorage.setItem('my_balances_v1', JSON.stringify(balances));
        }

        function updateUI() {
            const list = document.getElementById('record-list');
            list.innerHTML = records.map(r => `
                <div class="record-item type-${r.type}">
                    <div>
                        <b>${r.telco}</b> - RM ${r.amount.toFixed(2)}<br>
                        <small>${r.name} | ${r.time}</small>
                    </div>
                    <button onclick="deleteRecord(${r.id})" style="color:red; background:none;">✕</button>
                </div>
            `).join('');
            document.getElementById('record-title').innerText = `今日记录 (${records.length})`;
            updateLivePreview();
        }

        function deleteRecord(id) {
            const i = records.findIndex(r => r.id === id);
            const r = records[i];
            if(r.type === 'minus') balances[r.telco] += r.amount;
            else balances[r.telco] -= r.amount;
            records.splice(i, 1);
            saveData();
            updateUI();
        }

        function updateLivePreview() {
            const telco = document.getElementById('telco').value;
            const bal = balances[telco] || 0;
            document.getElementById('live-bal-view').innerText = `库存: RM ${bal.toFixed(2)}`;
        }

        function toggleSidePanel() {
            const p = document.getElementById('side-panel');
            const o = document.getElementById('side-overlay');
            const isOpen = p.classList.toggle('open');
            o.style.display = isOpen ? 'block' : 'none';
        }

        function exportCSV() {
            let csv = "时间,电讯商,类型,金额,客户,支付方式\n";
            records.forEach(r => {
                csv += `${r.time},${r.telco},${r.type},${r.amount},${r.name},${r.method}\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `账单_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // 初始化加载
        window.onload = loadConfigs;
    </script>
</body>
</html>